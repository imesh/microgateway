# Apigee Microgateway Installation Guide for Kubernetes

This installation guide provide instructions and manifests required for deploying Apigee Microgateway on Kubernetes. 

Apigee Microgateway is orchestrated on Kubernetes using a [Kubernetes Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/). The Microgateway configuration file and other configuration parameters are provided to the Microgateway pods using a [Kubernetes Secret](https://kubernetes.io/docs/concepts/configuration/secret/). The Microgateway API endpoint can be exposed either using a [Load Balancer](https://kubernetes.io/docs/concepts/configuration/secret/) or an [Istio Gateway](https://istio.io/latest/docs/reference/config/networking/gateway/).

First, complete [prerequisites](#Prerequisites) step and move to the other steps according your requirement. The deployment options included in this guide can be found in the below outline.

## Outline

- [Prerequisites](#Prerequisites)
- [Deploy Microgateway on Kubernetes without enabling TLS](#Deploy-Microgateway-on-Kubernetes-without-enabling-TLS)
- [Deploy Microgateway on Kubernetes with Northbound One-Way TLS](#Deploy-Microgateway-on-Kubernetes-with-Northbound-One-Way-TLS)
- [Deploy Microgateway on Kubernetes with Northbound Two-Way TLS](#Deploy-Microgateway-on-Kubernetes-with-Northbound-Two-Way-TLS)
- [Expose Microgateway using a Load Balancer](#Expose-Microgateway-using-a-Load-Balancer)
- [Expose Microgateway using an Istio Gateway without enabling TLS](#Expose-Microgateway-using-an-Istio-Gateway-without-enabling-TLS)
- [Expose Microgateway using an Istio Gateway with TLS passthrough](#Expose-Microgateway-using-an-Istio-Gateway-with-TLS-passthrough)
- [Undeploy Microgateway](#Undeploy-Microgateway)


## Prerequisites

1. Install Microgateway on a host which has internet connectivity:
   ```
   npm install edgemicro -g
   ```
   Please refer to [Microgateway Installation Guide](https://docs.apigee.com/api-platform/microgateway/3.2.x/installing-edge-microgateway) for detailed information. 

2. Generate Microgateway Configuration file, key and secret:
   ```
   edgemicro init

   MGW_ORG=#Apigee organization
   MGW_ENV=#Apigee environment
   MGW_USER=#Apigee username

   # For Edge Cloud, if basic auth is used
   edgemicro configure -o $MGW_ORG -e $MGW_ENV -u $MGW_USER

   # For Edge Cloud, if OAuth is used
   edgemicro configure -o $MGW_ORG -e $MGW_ENV -t $(get_token)
   ```

   ```
   edgemicro v3.2.1
   Usage: configure [options]

   Automated, one-time configuration with Edge Cloud

   Options:
     -o, --org <org>                    the organization
     -e, --env <env>                    the environment
     -v, --virtualHosts <virtualHosts>  override virtualHosts (default: "default,secure")
     -u, --username <user>              username of the organization admin
     -p, --password <password>          password of the organization admin
     -t, --token <token>                OAuth token to use with management API
     -r, --url <url>                    organization's custom API URL (https://api.example.com)
     -d, --debug                        execute with debug output
     -c, --configDir <configDir>        Set the directory where configs are written.
     -x, --proxyName <proxyName>        Set the custom proxy name for edgemicro-auth
     -k  --key <key>                    Path to private key to be used by Apigee Edge
     -s  --cert <cert>                  Path to certificate to be used by Apigee Edge
     -h, --help                         output usage information
   ```

   Please refer to [Setting up and configuring Edge Microgateway](https://docs.apigee.com/api-platform/microgateway/3.2.x/setting-and-configuring-edge-microgateway) for detailed information.

3. Configure kubectl CLI pointing to your Kubernetes cluster:

   - On Google Kubernetes Engine (GKE), execute below command to configure kubectl CLI:

     ```
     gcloud container clusters get-credentials [CLUSTER-NAME] --zone [ZONE] --project [GCP-PROJECT-ID]
     ```

   - Please refer [Kubernetes documentation](https://kubernetes.io/docs/tasks/tools/) or to the relevant cloud platform documentation for any other Kubernetes deployment.


4. Create a new folder on your local machine and download Kubernetes manifests files found in the `manifests/` folder of this repository:
   
   For an example:
   ```
   /opt/apigee/microgateway/kubernetes/manifests/
   ```

## Deploy Microgateway on Kubernetes without enabling TLS

1. Generate Microgateway Kubernetes secret:
   
   ```
   # Define context
   MGW_KEY=#key generated by "edgemicro config" command
   MGW_SECRET=#secret generated by "edgemicro config" command
   MGW_CONFIG=$(cat microgateway-config.yaml | base64)

   # Create Microgateway Kubernetes secret
   kubectl create secret generic mgwsecret --from-literal=mgw-config=$MGW_CONFIG --from-literal=mgw-org=$MGW_ORG --from-literal=mgw-env=$MGW_ENV --from-literal=mgw-key=$MGW_KEY --from-literal=mgw-secret=$MGW_SECRET
   ```

2. Deploy Microgateway on Kubernetes:
   
   ```
   # Create Microgateway Kubernetes deployment
   kubectl apply -f manifests/edge-microgateway.yaml
   ```

3. Expose Microgateway API endpoint using one of the following options:

   - [Expose Microgateway using a Load Balancer](#expose-microgateway-using-a-load-balancer)
   - [Expose Microgateway using an Istio Gateway without enabling TLS]((#expose-microgateway-using-an-istio-gateway-without-enabling-tls))


## Deploy Microgateway on Kubernetes with Northbound One-Way TLS

1. Generate a TLS certificate and a key file for enabling one-way TLS in the Microgateway. Copy these files using the filenames server.pem and server.key to the current directory.

2. Update Microgateway configuration file and configure ssl/key and ssl/cert properties exactly as specified below. Microgateway Kubernetes deployment will mount `/opt/apigee/tls/server.key` and `/opt/apigee/tls/server.pem` files to the containers using the Microgateway Kubernetes secret. Name Microgateway configuration file as `microgateway-config-northbound-one-way-tls.yaml`.
   
   ```
   ...
   edgemicro:
     ...
     ssl:
       key: /opt/apigee/tls/server.key
       cert: /opt/apigee/tls/server.pem
     ...
   ```

3. Generate Microgateway Kubernetes secret:

   ```
   # Define context
   MGW_KEY=#key generated by "edgemicro config" command
   MGW_SECRET=#secret generated by "edgemicro config" command
   MGW_CONFIG=$(cat microgateway-config-northbound-one-way-tls.yaml | base64)
   MGW_NORTHBOUND_TLS_SERVER_KEY=$(cat server.key)
   MGW_NORTHBOUND_TLS_SERVER_CERT=$(cat server.pem)

   # Create Microgateway Kubernetes secret
   kubectl create secret generic mgwsecret --from-literal=mgw-config=$MGW_CONFIG --from-literal=mgw-org="$MGW_ORG" --from-literal=mgw-env="$MGW_ENV" --from-literal=mgw-key="$MGW_KEY" --from-literal=mgw-secret="$MGW_SECRET" --from-literal=mgw-northbound-tls-server-key="$MGW_NORTHBOUND_TLS_SERVER_KEY" --from-literal=mgw-northbound-tls-server-cert="$MGW_NORTHBOUND_TLS_SERVER_CERT"
   ```

4. Deploy Microgateway on the Kubernetes cluster:
   
   ```
   kubectl apply -f manifests/edge-microgateway-northbound-one-way-tls.yaml
   ```

5. Expose Microgateway API endpoint using one of the following options:

   - [Expose Microgateway using a Load Balancer](#expose-microgateway-using-a-load-balancer)
   - [Expose Microgateway using an Istio Gateway with TLS passthrough]((#expose-microgateway-using-an-istio-gateway-with-tls-passthrough))


## Deploy Microgateway on Kubernetes with Northbound Two-Way TLS

1. Generate a TLS certificate for the Microgateway server and another TLS certificate for the client. Copy generated files to the current directory using following filenames `server.pem, server.key, client.pem, client.key, client-ca.pem`.

2. Update Microgateway configuration file and configure `ssl key`, `cert`, `requestCert`, and `ca` properties exactly as specified below. Microgateway Kubernetes deployment will mount `/opt/apigee/tls/server.key`, `/opt/apigee/tls/server.pem` and `/opt/apigee/tls/client-ca.pem` files to the Microgateway pods using the Microgateway Kubernetes secret. Name Microgateway configuration file as `microgateway-config-northbound-two-way-tls.yaml`.
   
   ```
   ...
   edgemicro:
     ...
     ssl:
       key: /opt/apigee/tls/server.key
       cert: /opt/apigee/tls/server.pem
       requestCert: true
       ca: /opt/apigee/tls/client-ca.pem
     ...
   ```

3. Generate Microgateway Kubernetes secret:

   ```
   # Define context
   MGW_KEY=#key generated by "edgemicro config" command
   MGW_SECRET=#secret generated by "edgemicro config" command
   MGW_CONFIG=$(cat microgateway-config-northbound-one-way-tls.yaml | base64)
   MGW_NORTHBOUND_TLS_SERVER_KEY=$(cat server.key)
   MGW_NORTHBOUND_TLS_SERVER_CERT=$(cat server.pem)
   MGW_NORTHBOUND_TLS_CLIENT_CA_CERT=$(cat client-ca.pem)

   # Create Microgateway Kubernetes secret
   kubectl create secret generic mgwsecret --from-literal=mgw-config="$MGW_CONFIG" --from-literal=mgw-org="$MGW_ORG" --from-literal=mgw-env="$MGW_ENV" --from-literal=mgw-key="$MGW_KEY" --from-literal=mgw-secret="$MGW_SECRET" --from-literal=mgw-northbound-tls-server-key="$MGW_NORTHBOUND_TLS_SERVER_KEY" --from-literal=mgw-northbound-tls-server-cert="$MGW_NORTHBOUND_TLS_SERVER_CERT" --from-literal=mgw-northbound-tls-client-ca-cert="$MGW_NORTHBOUND_TLS_CLIENT_CA_CERT"
   ```

4. Deploy Microgateway on the Kubernetes cluster:
   
   ```
   kubectl apply -f manifests/edge-microgateway-northbound-two-way-tls.yaml
   ```

5. Expose Microgateway API endpoint using one of the following options:

   - [Expose Microgateway using a Load Balancer](#expose-microgateway-using-a-load-balancer)
   - [Expose Microgateway using an Istio Gateway with TLS passthrough](#expose-microgateway-using-an-istio-gateway-with-tls-passthrough)


## Expose Microgateway using a Load Balancer

1. Execute below command to expose Microgateway using a cloud platform load balancer. This step will create a Load Balancer type Kubernetes service using the name `edge-microgateway-load-balancer`. As a result, the cloud platform will create a TCP load balancer and route traffic to the Microgateway pods via the Kubernetes service through the  port 8000:
   ```
   kubectl expose deployment edge-microgateway --type=LoadBalancer --name=edge-microgateway-load-balancer
   ```

2. Wait until the Load Balancer get an external IP address assigned:
   ```
   kubectl get service edge-microgateway-load-balancer
   ```

   An example output:
   ```
   NAME                              TYPE           CLUSTER-IP   EXTERNAL-IP     PORT(S)          AGE
   edge-microgateway-load-balancer   LoadBalancer   10.8.0.189   34.123.45.678   8000:31272/TCP   39h
   ```

3. Assign the external IP address of the Load Balancer to an environment variable:

   ```
   export GATEWAY_IP=$(kubectl get service \
   edge-microgateway-load-balancer \
   -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

   echo $GATEWAY_IP
   ```

4. Send a sample API request and verify the deployment:

   ```
   curl -i http://$GATEWAY_IP:8000/[PROXY-PATH]
   ```


## Expose Microgateway using an Istio Gateway without enabling TLS

1. [Install Istio Service Mesh](https://istio.io/latest/docs/setup/) on Kubernetes if it is not already installed.

2. Find Istio Gateway external IP address:

   ```
   kubectl get svc istio-ingressgateway -n istio-system
   
   export GATEWAY_IP=$(kubectl -n istio-system get service \
   istio-ingressgateway \
   -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
   
   echo $GATEWAY_IP
   ```

3. Deploy Istio Gateway manifests:

   ```
   kubectl apply -f manifests/edge-microgateway-istio-gateway-http-manifests.yaml
   ```

4. Send an API request and verify the deployment:

   ```
   curl -i http://$GATEWAY_IP/[PROXY-PATH]
   ```


## Expose Microgateway using an Istio Gateway with TLS passthrough

1. [Install Istio Service Mesh](https://istio.io/latest/docs/setup/) on Kubernetes if it is not already installed.

2. Find Istio Gateway external IP address:

   ```
   kubectl get svc istio-ingressgateway -n istio-system
   
   export GATEWAY_IP=$(kubectl -n istio-system get service \
   istio-ingressgateway \
   -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
   
   echo $GATEWAY_IP
   ```

3. Deploy Istio Gateway manifests:

   ```
   kubectl apply -f manifests/edge-microgateway-istio-gateway-https-manifests.yaml
   ```

4. Send an API request and verify the deployment:

   - If microgateway is deployed with northbound one-way TLS:
   ```
   curl -i https://$GATEWAY_IP/[PROXY-PATH]
   ```

   - If microgateway is deployed with northbound two-way TLS:
   ```
   curl -i --key client.key --cert client.cert https://$GATEWAY_IP/[PROXY-PATH]
   ```

## Undeploy Microgateway

   Execute below command to delete all resources created for deploying Microgateway on Kubernetes:
   ```
   kubectl delete -f manifests/*
   ```